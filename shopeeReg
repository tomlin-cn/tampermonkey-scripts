// ==UserScript==
// @name         Shopeeå°å°¼æ³¨å†Œè‡ªåŠ¨æ¥ç åŠ©æ‰‹(å®šå‘ä¿®å¤ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      3.5
// @description  å®šå‘ä¿®å¤ï¼šä¿®æ­£é‚®ç®±æå–æ­£åˆ™ï¼Œé‚®ä»¶OTPå»¶è¿Ÿé™æ¬¡ï¼Œå¼ºåŒ–OTPé¡µé¢ç›‘æ§
// @author       You
// @match        https://shopee.co.id/buyer/signup*
// @match        https://shopee.co.id/?is_from_signup=true*
// @match        https://shopee.co.id/user/account/email*
// @match        https://console.bitbrowser.net/*
// @match        https://shopee.co.id/user/account/profile*
// @connect      lubansms.com
// @connect      bsh.bhdata.com
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_setClipboard
// ==/UserScript==

(function() {
    'use strict';

    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        apiKey: "e1a755c652d70dd71c8b8461e19d762a",
        serviceId: "509521",
        baseUrl: "https://lubansms.com/v2/api",
        emailOtpUrl: "https://bsh.bhdata.com:30015/e7g1Ysq/",
        maxResend: 4,
        pollInterval: 3000,
        waitTimeout: 60000
    };

    let state = { phone: "", requestId: "", resendCount: 0, timer: null, startTime: 0, emailAttemptCount: 0 };

    // ================= è·¯ç”±åˆ†å‘ =================
    const currentUrl = window.location.href;
    if (currentUrl.includes("console.bitbrowser.net")) runBitBrowserExtractor();
    else if (currentUrl.includes("shopee.co.id/buyer/signup")) createUI();
    else if (currentUrl.includes("is_from_signup=true")) window.location.href = "https://shopee.co.id/user/account/email";
    else if (currentUrl.includes("shopee.co.id/user/account/email")) { createUI(); runAutoFillEmail(); startEmailOtpMonitor(); }
    else if (currentUrl.includes("shopee.co.id/user/account/profile")) { createUI(); }
    // ================= 1. ä¿®æ­£åçš„é‚®ç®±æå– (å»æ‰å‰é¢çš„å‡å·) =================
    function runBitBrowserExtractor() {
        const scanTimer = setInterval(() => {
            document.querySelectorAll('.row-left .bd').forEach(div => {
                if (div.innerText.includes("åç§°")) {
                    const hdDiv = div.nextElementSibling;
                    if (hdDiv && hdDiv.innerText.includes("@")) {
                        // ä¿®æ­£ï¼šå¼ºåˆ¶é¦–å­—æ¯ä¸ºæ•°å­—æˆ–å­—æ¯
                        const emailRegex = /[a-zA-Z0-9][a-zA-Z0-9._%+-]*@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
                        const emailMatch = hdDiv.innerText.match(emailRegex);
                        if (emailMatch) {
                            GM_setValue("saved_shopee_email", emailMatch[0].trim());
                            div.style.backgroundColor = "#ccffcc";
                            clearInterval(scanTimer);
                        }
                    }
                }
            });
        }, 2000);
    }

    // ================= 2. é‚®ä»¶OTPå®šå‘ä¿®æ”¹ (10ç§’å»¶è¿Ÿ+2æ¬¡é™æ¬¡) =================
    function startEmailOtpMonitor() {
        const monitorTimer = setInterval(() => {
            const notice = document.querySelector('div.Z5RLqi');
            if (notice && notice.innerText.includes("e-mail")) {
                clearInterval(monitorTimer);
                const email = GM_getValue("saved_shopee_email");
                log(`ğŸ“© é‚®ä»¶ç æµç¨‹ï¼šç­‰å¾… 10s åå¼€å§‹æŸ¥ç ...`);

                state.emailAttemptCount = 0; // é‡ç½®è®¡æ•°
                setTimeout(() => {
                    log("ğŸ” å¼€å§‹æ‰§è¡Œé‚®ä»¶ç æ¥æ”¶...");
                    state.emailTimer = setInterval(() => {
                        state.emailAttemptCount++;
                        log(`é‚®ä»¶æŸ¥ç ç¬¬ ${state.emailAttemptCount} æ¬¡...`);

                        GM_xmlhttpRequest({
                            method: "GET",
                            url: CONFIG.emailOtpUrl + email,
                            onload: function(response) {
                                try {
                                    const res = JSON.parse(response.responseText);
                                    if (res.code === 0 && res.data && res.data.result) {
                                        const code = (res.data.result.match(/(?<!\d)\d{6}(?!\d)/) || [])[0];
                                        if (code) {
                                            log(`âœ… é‚®ä»¶ç : ${code}`);
                                            clearInterval(state.emailTimer);
                                            fillOTP(code);
                                            return;
                                        }
                                    }
                                } catch (e) {}

                                // è¶…è¿‡2æ¬¡åœæ­¢å¹¶æç¤º
                                if (state.emailAttemptCount >= 2) {
                                    clearInterval(state.emailTimer);
                                    log("âŒ é‚®ä»¶ç å·²è¯·æ±‚2æ¬¡æ— æœï¼Œè¯·ã€äººå·¥ä»‹å…¥ã€‘");
                                }
                            }
                        });
                    }, 5000);
                }, 10000); // 10ç§’å»¶è¿Ÿ
            }
        }, 2000);
    }

    // ================= 3. æŸ¥ç ç›‘æ§å¼ºåŒ– (é’ˆå¯¹ _EqsPO) =================
    function waitForOTPInput() {
        log("ğŸ”„ å¼€å¯æŸ¥ç é¡µé¢ç›‘æ§...");
        const checkItv = setInterval(() => {
            // åªè¦æ£€æµ‹åˆ°ä½ è¯´çš„è¿™ä¸ª DIV å‡ºç°ï¼Œå°±è¯´æ˜è¿›åˆ°æ¥ç é¡µäº†
            const otpLabel = document.querySelector('div._EqsPO') || xpath("//div[contains(text(),'Masukkan Kode OTP')]");

            if (otpLabel) {
                clearInterval(checkItv);
                log("ğŸš€ [æ£€æµ‹æˆåŠŸ] å·²è¿›å…¥æ¥ç é¡µï¼Œå¯åŠ¨é²ç­æŸ¥ç å®šæ—¶å™¨...");
                state.startTime = Date.now();
                if (state.timer) clearInterval(state.timer);
                state.timer = setInterval(checkSMS, CONFIG.pollInterval);
            }
        }, 1000);
    }

    // ================= ä»¥ä¸‹ä¸ºè¿˜åŸåŸæœ¬æ­£å¸¸çš„ä»£ç ï¼Œä¸åšå¤šä½™æ”¹åŠ¨ =================

    function createUI() {
        if(document.getElementById('btn_start')) return;
        // --- æ–°å¢ï¼šå°è¯•ä»æ•°æ®åº“è¯»å–ä¹‹å‰ä¿å­˜çš„å·ç  ---
        if (!state.phone) {
            state.phone = GM_getValue("last_fetched_phone", "");
        }
    // ---------------------------------------
        const div = document.createElement('div');
        div.style = "position: fixed; top: 10px; right: 10px; background: #fff; border: 2px solid #ee4d2d; z-index: 999999; padding: 15px; border-radius: 8px; font-family: sans-serif; width: 220px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);";
        div.innerHTML = `
            <h3 style="margin:0 0 10px 0; color:#ee4d2d; font-size:16px; font-weight:bold;">ShopeeåŠ©æ‰‹</h3>
            <div id="msg_log" style="font-size:12px; color:#333; margin-bottom:10px; height:100px; overflow-y:auto; border:1px solid #eee; padding:5px; background:#f9f9f9;">å‡†å¤‡å°±ç»ª...</div>
            <button id="btn_start" style="width:100%; padding: 8px; background:#ee4d2d; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-bottom:8px;">å¼€å§‹æ³¨å†Œ (å–å·)</button>
            <button id="btn_copy" style="width:100%; padding: 6px; background:#555; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">ä¸€é”®å¤åˆ¶å·ç </button>
        `;
        document.body.appendChild(div);
        document.getElementById('btn_start').onclick = startProcess;
        document.getElementById('btn_copy').onclick = () => { if(state.phone) { GM_setClipboard(state.phone); log("ğŸ“‹ å·²å¤åˆ¶"); } };
    }

    function startProcess() {
        log("æ­£åœ¨è¯·æ±‚é²ç­å·ç ...");
        GM_xmlhttpRequest({
            method: "GET",
            url: `${CONFIG.baseUrl}/getNumber?apikey=${CONFIG.apiKey}&service_id=${CONFIG.serviceId}`,
            onload: function(response) {
                try {
                    const res = JSON.parse(response.responseText);
                    const gotPhone = res.phone || res.mobile || res.number || (res.data ? (typeof res.data === 'string' ? res.data : res.data.phone) : null);
                    if (gotPhone) {
                        state.phone = gotPhone;
                        GM_setValue("last_fetched_phone", gotPhone); // å­˜å…¥æ•°æ®åº“ï¼Œé˜²æ­¢è·³è½¬åä¸¢å¤±
                        state.phone = gotPhone; state.requestId = res.request_id || (res.data ? res.data.request_id : "");
                        log(`âœ… è§£ææˆåŠŸ: ${state.phone}`);
                        document.getElementById('btn_copy').innerText = "å¤åˆ¶: " + state.phone;
                        fillPhoneAndSubmit();
                    }
                } catch (e) {}
            }
        });
    }

    function fillPhoneAndSubmit() {
        const input = document.querySelector('input[name="phone"]');
        if (!input) return;
        fillReactInput(input, state.phone);
        let itv = setInterval(() => {
            const allBtns = document.querySelectorAll('button');
            for (let btn of allBtns) {
                if (btn.innerText.toUpperCase().includes("BERIKUTNYA") && !btn.disabled) {
                    clearInterval(itv); btn.click(); findAgreeButton(); break;
                }
            }
        }, 500);
    }

    function findAgreeButton() {
        let itv = setInterval(() => {
            const btn = xpath("//button[contains(., 'Setuju')]");
            if (btn) { clearInterval(itv); btn.click(); waitForCaptchaSuccess(); }
        }, 500);
    }

    function waitForCaptchaSuccess() {
        const itv = setInterval(() => {
            const methodBtn = xpath("//button[contains(text(),'Metode Lain')]");
            if (methodBtn && methodBtn.offsetParent !== null) {
                clearInterval(itv);
                setTimeout(() => { methodBtn.click(); switchToSMS(); }, 2000);
            }
        }, 1000);
    }

    function switchToSMS() {
        setTimeout(() => {
            const smsBtn = xpath("//button[contains(., 'SMS')]");
            if (smsBtn) { smsBtn.click(); waitForOTPInput(); }
        }, 1000);
    }

    function checkSMS() {
        if (Date.now() - state.startTime > CONFIG.waitTimeout) { handleResend(); return; }
        GM_xmlhttpRequest({
            method: "GET",
            url: `${CONFIG.baseUrl}/getSms?apikey=${CONFIG.apiKey}&request_id=${state.requestId}`,
            onload: function(response) {
                try {
                    const res = JSON.parse(response.responseText);
                    let code = res.sms_code || (JSON.stringify(res).match(/(?<!\d)\d{6}(?!\d)/) || [])[0];
                    if (code) {
                        log(`âœ… éªŒè¯ç : ${code}`);
                        clearInterval(state.timer);
                        setTimeout(() => fillOTP(code), 500);
                    }
                } catch (e) {}
            }
        });
    }

    function handleResend() {
        const btn = xpath("//button[contains(text(),'Kirim Ulang')]");
        if (btn && !btn.disabled) { btn.click(); state.startTime = Date.now(); }
    }

    function fillOTP(code) {
        const input = document.querySelector('input.w_Qhj0') || document.querySelector('input[autocomplete="one-time-code"]');
        if (input) {
            fillReactInput(input, code);
            setTimeout(() => {
                const btn = xpath("//button[contains(., 'Lanjut')]") || document.querySelector('button.qz7ctP');
                if (btn) {
                    btn.click();
                    if (window.location.href.includes("signup")) waitForPasswordAndSubmit();
                }
            }, 800);
        }
    }

    function waitForPasswordAndSubmit() {
        const itv = setInterval(() => {
            const input = document.querySelector('input[name="password"]');
            if (input) {
                clearInterval(itv);
                fillReactInput(input, "Aa112211.");
                setTimeout(() => {
                    const btn = xpath("//button[contains(., 'Daftar')]");
                    if (btn) btn.click();
                }, 2000);
            }
        }, 500);
    }

    function runAutoFillEmail() {
        const email = GM_getValue("saved_shopee_email");
        if (!email) return;
        const itv = setInterval(() => {
            const input = document.querySelector('input[name="email"]');
            if (input && !document.querySelector('div.Z5RLqi')) {
                clearInterval(itv); fillReactInput(input, email);
                setTimeout(() => {
                    const btn = xpath("//button[contains(., 'Selanjutnya')]") || document.querySelector('button.btn-solid-primary');
                    if (btn) btn.click();
                }, 2000);
            }
        }, 1000);
    }

    function fillReactInput(inputEl, value) {
        let lastValue = inputEl.value;
        inputEl.value = value;
        let event = new Event('input', { bubbles: true });
        event.simulated = true;
        let tracker = inputEl._valueTracker;
        if (tracker) tracker.setValue(lastValue);
        inputEl.dispatchEvent(event);
        try {
            let nativeSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
            nativeSetter.call(inputEl, value);
            inputEl.dispatchEvent(new Event('input', { bubbles: true }));
        } catch(e) {}
    }

    function xpath(query) { return document.evaluate(query, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue; }

    function log(msg) {
        const el = document.getElementById('msg_log');
        if (el) { el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + el.innerHTML; }
    }

})();
